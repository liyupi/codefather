# å…¬å¸æ¥äº†ä½ â€œæ–°åŒäº‹â€ï¼Œä¸“é—¨æé†’å‘˜å·¥æ¥æ°´ï¼Ÿ

> æœ¬æ–‡ä½œè€…ï¼š[ç¨‹åºå‘˜é±¼çš®](https://yuyuanweb.feishu.cn/wiki/Abldw5WkjidySxkKxU2cQdAtnah)
>
> æœ¬ç«™åœ°å€ï¼š[https://codefather.cn](https://codefather.cn)

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯é±¼çš®ï¼Œä»Šå¤©åˆ†äº«ä¸€ä¸ªç”¨ç¨‹åºè§£å†³ç”Ÿæ´»å·¥ä½œé—®é¢˜çš„çœŸå®æ¡ˆä¾‹ã€‚

è¯´æ¥æƒ­æ„§ï¼Œäº‹æƒ…æ˜¯è¿™æ ·çš„ï¼Œåœ¨æˆ‘ä»¬å…¬å¸ï¼Œæ¯å¤©éƒ½è¦è½®æµå®‰æ’ä¸€åå‘˜å·¥ï¼ˆå½“ç„¶ä¹ŸåŒ…æ‹¬æˆ‘ï¼‰å»æ¥¼å±‚ä¸­é—´ä¸€ä¸ªå¾ˆç‰›çš„é¥®æ°´æœºé‚£é‡Œæ¥æ°´ã€‚ä½†ç”±äºå¤§å®¶æ¯å¤©éƒ½æœ‰è‡ªå·±çš„å·¥ä½œï¼Œç»å¸¸å‡ºç°å¿˜è®°æ¥æ°´çš„æƒ…å†µï¼Œå¯¼è‡´å¤§å®¶å£æ¸´éš¾è€ã€‚

æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ

æˆ‘æƒ³åˆ°äº†å‡ ç§æ–¹æ³•ï¼š

1ï¼‰æ¯å¤©å¤§å®¶è½®æµæé†’ã€‚ä½†æ˜¯åˆ«è¯´æé†’åˆ«äººäº†ï¼Œè‡ªå·±éƒ½ä¸è®°å¾—ä»€ä¹ˆæ—¶å€™è½®åˆ°è‡ªå·±æ¥æ°´ã€‚

2ï¼‰ç”±ä¸€ä¸ªå‘˜å·¥è´Ÿè´£æé†’å¤§å®¶æ¥æ°´ï¼Œå¿…è¦æ—¶æ‹›å‹Ÿä¸€ä¸ª â€œæ¥æ°´æé†’å‘˜â€ã€‚

3ï¼‰åœ¨ä¼ä¸šå¾®ä¿¡çš„æ—¥å†åŠŸèƒ½ç»™å‘˜å·¥å®‰æ’æ¥æ°´æ—¥ç¨‹ï¼Œå°±åƒä¸‹é¢è¿™æ ·ï¼š

![](https://yupi-picture-1256524210.cos.ap-shanghai.myqcloud.com/1/image-20231014144412018.png)

ä½†é—®é¢˜æ˜¯æˆ‘ä»¬çš„äººæ•°å’Œå¤©æ•°ä¸æ˜¯å®Œå…¨å¯¹åº”çš„ã€åå¤å®‰æ’æ—¥ç¨‹ä¹Ÿå¾ˆéº»çƒ¦ã€‚

ä½ è§‰å¾—ä¸Šé¢å“ªç§æ–¹æ¡ˆå¥½å‘¢ï¼Ÿå…¶å®æˆ‘è§‰å¾—ç¬¬äºŒä¸ªæ–¹æ¡ˆæ˜¯æœ€å¥½çš„ â€”â€” æ‹›å‹Ÿä¸€ä¸ª â€œæ¥æ°´æé†’å‘˜â€ã€‚

åˆ«ç¬‘ï¼Œæˆ‘è®¤çœŸçš„ï¼

åªä¸è¿‡è¿™ä¸ª â€œæ¥æ°´æé†’å‘˜â€ ä½•å¿…æ˜¯äººï¼Ÿ

æ²¡é”™ï¼Œä½œä¸ºä¸€åç¨‹åºå‘˜ï¼Œæˆ‘ä»¬å¯ä»¥æä¸€ä¸ªæœºå™¨äººï¼Œè®©å®ƒåœ¨ä¼ä¸šå¾®ä¿¡ç¾¤èŠä¸­æ¯å¤©æé†’ä¸åŒçš„å‘˜å·¥å»æ¥æ°´å³å¯ã€‚

å…¶å®è¿™ä¸ªåŠŸèƒ½å’Œå‘˜å·¥æ’ç­æ‰“å¡ç³»ç»Ÿæ˜¯å¾ˆç±»ä¼¼çš„ï¼Œåªä¸è¿‡æ›´è½»é‡ä¸€äº›ã€‚æˆ‘ä¹Ÿè°ƒç ”äº†å¾ˆå¤šæ’ç­ç³»ç»Ÿï¼Œä½†æ˜¯éƒ½è¦æ”¶è´¹ï¼Œç´¢æ€§è‡ªå·±å¼€å‘ä¸€ä¸ªå¥½äº†ã€‚

åœ¨ä¼ä¸šå¾®ä¿¡ä¸­æ¥å…¥æœºå™¨äººå…¶å®éå¸¸ç®€å•ï¼Œå› ä¸ºä¼ä¸šå¾®ä¿¡å®˜æ–¹å°±æ”¯æŒç¾¤èŠæœºå™¨äººåŠŸèƒ½ï¼Œæ‰€ä»¥è¿™æ¬¡çš„ä»»åŠ¡æˆ‘å°±å®‰æ’ç»™äº†å®ä¹ ç”Ÿï¼Œä»–å¾ˆå¿«å°±å®Œæˆäº†ï¼Œæ‰€ä»¥æˆ‘ç›¸ä¿¡å¤§å®¶åº”è¯¥ä¹Ÿéƒ½èƒ½å­¦ä¼š~



## ä¼å¾®ç¾¤èŠæœºå™¨äººå¼€å‘

å­¦ä¹ å¼€å‘ç¬¬ä¸‰æ–¹åº”ç”¨æ—¶ï¼Œä¸€å®šè¦å…ˆå®Œæ•´é˜…è¯»å®˜æ–¹æ–‡æ¡£ï¼Œæ¯”å¦‚ä¼ä¸šå¾®ä¿¡ç¾¤æœºå™¨äººé…ç½®æ–‡æ¡£ã€‚

> æŒ‡è·¯ï¼šhttps://developer.work.weixin.qq.com/document/path/99110

![](https://yupi-picture-1256524210.cos.ap-shanghai.myqcloud.com/1/image-20231014145353399.png)



### è®¾è®¡ SDK ç»“æ„

è™½ç„¶æˆ‘ä»¬çš„ç›®æ ‡æ˜¯åšä¸€ä¸ªæé†’æ¥æ°´æœºå™¨äººï¼Œä½†æ˜¯ä¼ä¸šå¾®ä¿¡ç¾¤èŠæœºå™¨äººå…¶å®æ˜¯ä¸€ä¸ªé€šç”¨çš„åŠŸèƒ½ï¼Œæ‰€ä»¥æˆ‘ä»¬å†³å®šå¼€å‘ä¸€ä¸ªä¼å¾®æœºå™¨äºº SDKï¼Œä»¥åå…¬å¸å…¶ä»–ä¸šåŠ¡éœ€è¦æ—¶éƒ½èƒ½å¤Ÿå¿«é€Ÿå¤ç”¨ã€‚ï¼ˆæ¯”å¦‚å¼€å‘ä¸€ä¸ªå®šæ—¶å–æ°´æé†’æœºå™¨äººï¼‰

è®¾è®¡å¥½ SDK æ˜¯éœ€è¦ä¸€å®šæŠ€å·§çš„ï¼Œä¹‹å‰ç»™å¤§å®¶åˆ†äº«è¿‡ï¼š[å¦‚ä½•è®¾è®¡ä¸€ä¸ªä¼˜ç§€çš„ SDK](https://mp.weixin.qq.com/s?__biz=MzI1NDczNTAwMA==&mid=2247500703&idx=1&sn=bf4122b470fa6cccc1f005b6772a68f2&scene=21#wechat_redirect) ï¼Œå¯ä»¥é˜…è¯»å‚è€ƒã€‚

åœ¨æŸ¥é˜…ä¼å¾®æœºå™¨äººæ–‡æ¡£åï¼Œäº†è§£åˆ°ä¼ä¸šå¾®ä¿¡æœºå™¨äººæ”¯æŒå‘é€å¤šç§ç±»å‹çš„æ¶ˆæ¯ï¼ŒåŒ…æ‹¬æ–‡æœ¬ã€ Markdown ã€å›¾ç‰‡ã€å›¾æ–‡ã€æ–‡ä»¶ã€è¯­éŸ³å’Œæ¨¡å—å¡ç‰‡ç­‰ï¼Œæ–‡æ¡£ä¸­å¯¹æ¯ä¸€ç§ç±»å‹çš„è¯·æ±‚å‚æ•°å’Œå­—æ®µå«ä¹‰éƒ½åšäº†è¯¦å°½çš„è§£é‡Šã€‚

> åæ§½ä¸€ä¸‹ï¼Œè·Ÿå¾®ä¿¡å¼€å‘è€…æ–‡æ¡£æ¯”èµ·æ¥ï¼Œä¼å¾®æœºå™¨äººçš„æ–‡æ¡£å†™å¾—æ¸…æ™°å¤šäº†ï¼

![ä¼å¾®æ–‡æœ¬æ¶ˆæ¯æ ¼å¼](https://yupi-picture-1256524210.cos.ap-shanghai.myqcloud.com/1/image-20231014145911630.png)

ç”±äºæ¯ç§æ¶ˆæ¯æœ€ç»ˆéƒ½æ˜¯è¦è½¬æ¢æˆ JSON æ ¼å¼ä½œä¸º HTTP è¯·æ±‚çš„å‚æ•°çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®¾è®¡ä¸€ä¸ªåŸºç¡€çš„æ¶ˆæ¯ç±»ï¼ˆMessageï¼‰æ¥å­˜æ”¾å…¬å…±å‚æ•°ï¼Œç„¶åå®šä¹‰å„ç§ä¸åŒçš„å…·ä½“æ¶ˆæ¯ç±»æ¥é›†æˆå®ƒï¼ˆæ¯”å¦‚æ–‡æœ¬æ¶ˆæ¯ TextMessageã€Markdown æ¶ˆæ¯ MarkdownMessage ç­‰ï¼‰ã€‚

ä¸ºäº†ç®€åŒ–å¼€å‘è€…ä½¿ç”¨ SDK æ¥å‘é€æ¶ˆæ¯ï¼Œå®šä¹‰ç»Ÿä¸€çš„ MessageSender ç±»ï¼Œåœ¨ç±»ä¸­æä¾›å‘é€æ¶ˆæ¯çš„æ–¹æ³•ï¼ˆæ¯”å¦‚å‘é€æ–‡æœ¬æ¶ˆæ¯ sendTextï¼‰ï¼Œå¯ä»¥æ¥å— Message å¹¶å‘é€åˆ°ä¼ä¸šå¾®ä¿¡æœåŠ¡å™¨ã€‚

æœ€ç»ˆï¼Œå®¢æˆ·ç«¯åªéœ€è°ƒç”¨ç»Ÿä¸€çš„æ¶ˆæ¯å‘é€æ–¹æ³•å³å¯ã€‚SDK çš„æ•´ä½“ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://yupi-picture-1256524210.cos.ap-shanghai.myqcloud.com/1/1697195145097-6b77f8c8-dcd5-4904-b211-badac72e7a9c.png)

å€¼å¾—ä¸€æçš„æ˜¯ï¼Œå¦‚æœè¦åˆ¶ä½œæ›´é€šç”¨çš„æ¶ˆæ¯å‘é€ SDKã€‚å¯ä»¥å°† MessageSender å®šä¹‰æˆæ¥å£ï¼Œç¼–å†™ä¸åŒçš„å­ç±»æ¯”å¦‚é£ä¹¦ MessageSenderã€çŸ­ä¿¡ MessageSender ç­‰ã€‚



### å¼€å‘ SDK

åšå¥½è®¾è®¡ä¹‹åï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥å¼€å§‹å¼€å‘ SDK äº†ã€‚

æ­¥éª¤å¦‚ä¸‹ï¼š

1. è·å– webhook
2. åˆ›å»º SDK é¡¹ç›®
3. ç¼–å†™ä»£ç 
4. SDK æ‰“åŒ…
5. è°ƒç”¨ SDK



### 1ã€è·å– webhook	

é¦–å…ˆï¼Œå¿…é¡»åœ¨ä¼ä¸šå¾®ä¿¡ç¾¤èŠä¸­åˆ›å»ºä¸€ä¸ªä¼ä¸šå¾®ä¿¡æœºå™¨äººï¼Œå¹¶è·å–æœºå™¨äººçš„ webhookã€‚

webhook æ˜¯ä¸€ä¸ª url åœ°å€ï¼Œç”¨äºæ¥å—æˆ‘ä»¬å¼€å‘è€…è‡ªå·±æœåŠ¡å™¨çš„è¯·æ±‚ï¼Œä»è€Œæ§åˆ¶ä¼ä¸šå¾®ä¿¡æœºå™¨äººã€‚åç»­æ‰€æœ‰çš„å¼€å‘è¿‡ç¨‹ï¼Œéƒ½éœ€è¦é€šè¿‡ webhook æ‰å¯ä»¥å®ç°ã€‚

![](https://yupi-picture-1256524210.cos.ap-shanghai.myqcloud.com/1/image-20231014151024421.png)

å¤åˆ¶å¹¶ä¿å­˜å¥½è¿™ä¸ª Webhook åœ°å€ï¼Œæ³¨æ„ä¸è¦æ³„éœ²è¯¥åœ°å€ï¼

![](https://yupi-picture-1256524210.cos.ap-shanghai.myqcloud.com/1/1697194222438-40e7e7a8-3264-4844-b995-14183a0115f2.png)



### 2ã€åˆ›å»º SDK é¡¹ç›®

SDK é€šå¸¸æ˜¯ä¸€ä¸ªå¾ˆå¹²å‡€çš„é¡¹ç›®ï¼Œæ­¤å¤„æˆ‘ä»¬ä½¿ç”¨ Maven æ¥æ„å»ºä¸€ä¸ªç©ºçš„é¡¹ç›®ï¼Œå¹¶åœ¨ `pom.xml`  æ–‡ä»¶ä¸­é…ç½®é¡¹ç›®ä¿¡æ¯ã€‚

éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œæ—¢ç„¶æˆ‘ä»¬æ­£åœ¨åˆ›å»ºä¸€ä¸ª SDKï¼Œè¿™æ„å‘³ç€å®ƒå°†è¢«æ›´å¤šçš„å¼€å‘è€…ä½¿ç”¨ã€‚å› æ­¤ï¼Œåœ¨é…ç½® groupId å’Œ artifactId æ—¶ï¼Œæˆ‘ä»¬åº”å½“éµå¾ªä»¥ä¸‹è§„èŒƒï¼š

- groupIdï¼šå®ƒæ˜¯é¡¹ç›®ç»„ç»‡æˆ–é¡¹ç›®å¼€å‘è€…çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå…¶å®é™…å¯¹åº”çš„æ˜¯ main ç›®å½•ä¸‹çš„ Java ç›®å½•ç»“æ„ã€‚ 
- artifactIdï¼šå®ƒæ˜¯é¡¹ç›®çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå¯¹åº”çš„æ˜¯é¡¹ç›®åç§°ï¼Œå³é¡¹ç›®çš„æ ¹ç›®å½•åç§°ã€‚é€šå¸¸ï¼Œå®ƒåº”å½“ä¸ºçº¯å°å†™ï¼Œå¹¶ä¸”å¤šä¸ªè¯ä¹‹é—´ä½¿ç”¨ä¸­åˆ’çº¿ï¼ˆ-ï¼‰éš”å¼€ã€‚ 
- versionï¼šå®ƒæŒ‡å®šäº†é¡¹ç›®çš„å½“å‰ç‰ˆæœ¬ã€‚å…¶ä¸­ï¼ŒSNAPSHOT è¡¨ç¤ºè¯¥é¡¹ç›®ä»åœ¨å¼€å‘ä¸­ï¼Œæ˜¯ä¸€ä¸ªä¸ç¨³å®šçš„ç‰ˆæœ¬ã€‚

ä»¥ä¸‹æ˜¯æˆ‘ä»¬é…ç½®å¥½çš„é¡¹ç›®ä¿¡æ¯ï¼š

```xml
<groupId>com.yupi</groupId>
<artifactId>rtx-robot</artifactId>
<version>1.0-SNAPSHOT</version>
```

ä¸ºäº†è®©æˆ‘ä»¬çš„é¡¹ç›®æ›´åŠ æ˜“ç”¨ï¼Œæˆ‘ä»¬è¿˜è¦èƒ½åšåˆ°è®©å¼€å‘è€…é€šè¿‡é…ç½®æ–‡ä»¶æ¥ä¼ å…¥é…ç½®ï¼ˆæ¯”å¦‚ webhookï¼‰ï¼Œè€Œä¸æ˜¯é€šè¿‡ç¡¬ç¼–ç é‡å¤é…ç½®å„ç§ä¿¡æ¯ã€‚

æ‰€ä»¥æ­¤å¤„æˆ‘ä»¬æŠŠé¡¹ç›®åªä½œä¸º Spring Boot çš„ starterï¼Œéœ€è¦åœ¨ pom.xml æ–‡ä»¶ä¸­å¼•å…¥ä¾èµ–ï¼š

```xml
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-autoconfigure</artifactId>
</dependency>
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-configuration-processor</artifactId>
  <optional>true</optional>
</dependency>
```

æœ€åï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ·»åŠ ä¸€ä¸ªé…ç½®ï¼Œé…ç½®é¡¹  `<skip>true</skip>`  è¡¨ç¤ºè·³è¿‡æ‰§è¡Œè¯¥æ’ä»¶çš„é»˜è®¤è¡Œä¸ºï¼š

```xml
<build>
    <plugins>
        <plugin>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-maven-plugin</artifactId>
            <configuration>
                <skip>true</skip>
            </configuration>
        </plugin>
    </plugins>
</build>
```

è¿™æ ·ï¼Œä¸€ä¸ª SDK é¡¹ç›®çš„åˆå§‹ä¾èµ–å°±é…ç½®å¥½äº†ã€‚



### 3ã€ç¼–å†™é…ç½®ç±»

ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥æŒ‰ç…§ä¹‹å‰è®¾è®¡çš„ç»“æ„å¼€å‘äº†ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬è¦å†™ä¸€ä¸ªé…ç½®ç±»ï¼Œç”¨æ¥æ¥å—å¼€å‘è€…åœ¨é…ç½®æ–‡ä»¶ä¸­å†™å…¥çš„ webhookã€‚

åŒæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é…ç½®ç±»ä¸­ï¼Œå°†éœ€è¦è¢«è°ƒç”¨çš„ MessageSender å¯¹è±¡ Bean è‡ªåŠ¨æ³¨å…¥åˆ° IOC å®¹å™¨ä¸­ï¼Œä¸ç”¨è®©å¼€å‘è€…è‡ªå·± new å¯¹è±¡äº†ã€‚

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
@Configuration
@ConfigurationProperties(prefix = "wechatwork-bot")
@ComponentScan
@Data
public class WebhookConfig {

    private String webhook;

    @Bean
    public RtxRobotMessageSender rtxRobotMessageSender() {
        return new RtxRobotMessageSender(webhook);
    }
}
```



æ¥ä¸‹æ¥ï¼Œä¸ºäº†è®© Spring Boot é¡¹ç›®åœ¨å¯åŠ¨æ—¶èƒ½è‡ªåŠ¨è¯†åˆ«å¹¶åº”ç”¨é…ç½®ç±»ï¼Œéœ€è¦æŠŠé…ç½®ç±»å†™å…¥åˆ° `resources/META-INF/spring.factories ` æ–‡ä»¶ä¸­ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```sh
org.springframework.boot.autoconfigure.EnableAutoConfiguration=com.yupi.rtxrobot.config.WebhookConfig
```



### 4ã€ç¼–å†™æ¶ˆæ¯ç±»

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦æŒ‰ç…§å®˜æ–¹æ–‡æ¡£çš„è¯·æ±‚å‚æ•°æŠŠå‡ ç§ç±»å‹çš„æ¶ˆæ¯å¯¹è±¡ç¼–å†™å¥½ã€‚

ç”±äºæ¯ä¸ªæ¶ˆæ¯ç±»éƒ½æœ‰ä¸€ä¸ªå›ºå®šçš„å­—æ®µ msgtypeï¼Œæ‰€ä»¥æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªåŸºç±» Messageï¼Œæ–¹ä¾¿åç»­å°†ä¸åŒç±»å‹çš„æ¶ˆæ¯ä¼ å…¥ç»Ÿä¸€çš„æ–¹æ³•ï¼š

```java
public class Message {

    /**
     * æ¶ˆæ¯ç±»å‹
     **/
    String msgtype;
}
```

æ¥ä¸‹æ¥ç¼–å†™å…·ä½“çš„æ¶ˆæ¯ç±»ï¼Œæ¯”å¦‚çº¯æ–‡æœ¬ç±»å‹æ¶ˆæ¯ TextMessageï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
@Data
public class TextMessage extends Message {

    /**
     * æ¶ˆæ¯å†…å®¹
     */
    private String content;

    /**
     * è¢«æåŠè€…userIdåˆ—è¡¨
     */
    private List<String> mentionedList;

    /**
     * è¢«æåŠè€…ç”µè¯å·ç åˆ—è¡¨
     */
    private List<String> mentionedMobileList;
  
    /**
     * æåŠå…¨ä½“
     */
    private Boolean mentionAll = false;

    public TextMessage(String content, List<String> mentionedList, List<String> mentionedMobileList, Boolean mentionAll) {
        this.content = content;
        this.mentionedList = mentionedList;
        this.mentionedMobileList = mentionedMobileList;
        this.mentionAll = mentionAll;

        if (mentionAll) {
            if (CollUtil.isNotEmpty(this.mentionedList) || CollUtil.isNotEmpty(this.mentionedMobileList)) {
                if (CollUtil.isNotEmpty(mentionedList)) {
                    this.mentionedList.add("@all");
                } else {
                    this.mentionedList = CollUtil.newArrayList("@all");
                }
            } else {
                this.mentionedList = CollUtil.newArrayList("@all");
            }
        }
    }

    public TextMessage(String content) {
        this(content, null, null, false);
    }
}
```

ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæœ‰ä¸ªä»£ç ä¼˜åŒ–å°ç»†èŠ‚ï¼Œå®˜æ–¹æ–‡æ¡£æ˜¯ä½¿ç”¨ â€œ@allâ€ å­—ç¬¦ä¸²æ¥è¡¨ç¤º @å…¨ä½“æˆå‘˜çš„ï¼Œä½† â€œ@allâ€ æ˜¯ä¸€ä¸ªé­”æ³•å€¼ï¼Œä¸ºäº†ç®€åŒ–è°ƒç”¨ï¼Œæˆ‘ä»¬å°†å…¶å°è£…ä¸º mentionAll å¸ƒå°”ç±»å‹å­—æ®µï¼Œå¹¶ä¸”åœ¨æ„é€ å‡½æ•°ä¸­è‡ªåŠ¨è½¬æ¢ä¸ºå®é™…è¯·æ±‚éœ€è¦çš„å­—æ®µã€‚



### 5ã€ç¼–å†™æ¶ˆæ¯å‘é€ç±»

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ªæ¶ˆæ¯å‘é€ç±»ã€‚åœ¨è¿™ä¸ªç±»ä¸­ï¼Œå®šä¹‰äº†ç”¨äºå‘é€å„ç§ç±»å‹æ¶ˆæ¯çš„æ–¹æ³•ï¼Œå¹¶ä¸”æ‰€æœ‰çš„æ–¹æ³•éƒ½ä¼šä¾èµ–è°ƒç”¨åº•å±‚çš„ send æ–¹æ³•ã€‚send æ–¹æ³•çš„ä½œç”¨æ˜¯é€šè¿‡å‘ä¼å¾®æœºå™¨äººçš„ webhook åœ°å€å‘é€è¯·æ±‚ï¼Œä»è€Œé©±åŠ¨ä¼å¾®æœºå™¨äººå‘é€æ¶ˆæ¯ã€‚

ä»¥ä¸‹æ˜¯ç¤ºä¾‹ä»£ç ï¼Œæœ‰å¾ˆå¤šç¼–ç ç»†èŠ‚ï¼š

```java
/**
 * å¾®ä¿¡æœºå™¨äººæ¶ˆæ¯å‘é€å™¨
 * @author yuyuanweb
 */
@Slf4j
@Data
public class RtxRobotMessageSender {

    private final String webhook;
  
    public WebhookConfig webhookConfig;

    public RtxRobotMessageSender(String webhook) {
        this.webhook = webhook;
    }

    /**
     * æ”¯æŒè‡ªå®šä¹‰æ¶ˆæ¯å‘é€
     */
    public void sendMessage(Message message) throws Exception {
        if (message instanceof TextMessage) {
            TextMessage textMessage = (TextMessage) message;
            send(textMessage);
        } else if (message instanceof MarkdownMessage) {
            MarkdownMessage markdownMessage = (MarkdownMessage) message;
            send(markdownMessage);
        } else {
            throw new RuntimeException("Unsupported message type");
        }
    }

    /**
     * å‘é€æ–‡æœ¬ï¼ˆç®€åŒ–è°ƒç”¨ï¼‰
     */ 
    public void sendText(String content) throws Exception {
        sendText(content, null, null, false);
    }
  
    public void sendText(String content, List<String> mentionedList, List<String> mentionedMobileList) throws Exception {
        TextMessage textMessage = new TextMessage(content, mentionedList, mentionedMobileList, false);
        send(textMessage);
    }
    
    /**
     * å‘é€æ¶ˆæ¯çš„å…¬å…±ä¾èµ–åº•å±‚ä»£ç 
     */
    private void send(Message message) throws Exception {
        String webhook = this.webhook;
        String messageJsonObject = JSONUtil.toJsonStr(message);
      	// æœªä¼ å…¥é…ç½®ï¼Œé™çº§ä¸ºä»é…ç½®æ–‡ä»¶ä¸­å¯»æ‰¾
        if (StrUtil.isBlank(this.webhook)) {
            try {
                webhook = webhookConfig.getWebhook();
            } catch (Exception e) {
                log.error("æ²¡æœ‰æ‰¾åˆ°é…ç½®é¡¹ä¸­çš„webhook,è¯·æ£€æŸ¥ï¼š1.æ˜¯å¦åœ¨application.ymlä¸­å¡«å†™webhook 2.æ˜¯å¦åœ¨springç¯å¢ƒä¸‹è¿è¡Œ");
                throw new RuntimeException(e);
            }
        }
        OkHttpClient client = new OkHttpClient();
        RequestBody body = RequestBody.create(
                MediaType.get("application/json; charset=utf-8"),
                messageJsonObject);
        Request request = new Request.Builder()
                .url(webhook)
                .post(body)
                .build();
        try (Response response = client.newCall(request).execute()) {
            if (response.isSuccessful()) {
                log.info("æ¶ˆæ¯å‘é€æˆåŠŸ");
            } else {
                log.error("æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œå“åº”ç ï¼š{}", response.code());
                throw new Exception("æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œå“åº”ç ï¼š" + response.code());
            }
        } catch (IOException e) {
            log.error("å‘é€æ¶ˆæ¯æ—¶å‘ç”Ÿé”™è¯¯:" + e);
            throw new Exception("å‘é€æ¶ˆæ¯æ—¶å‘ç”Ÿé”™è¯¯", e);
        }
    }
}
```

ä»£ç éƒ¨åˆ†å°±åˆ°è¿™é‡Œï¼Œæ˜¯ä¸æ˜¯ä¹Ÿæ²¡æœ‰å¾ˆå¤æ‚ï¼Ÿ



### 6ã€SDK æ‰“åŒ…

æ¥ä¸‹æ¥å°±å¯ä»¥å¯¹ SDK è¿›è¡Œæ‰“åŒ…ï¼Œç„¶åæœ¬åœ°ä½¿ç”¨æˆ–è€…ä¸Šä¼ åˆ°è¿œç¨‹ä»“åº“äº†ã€‚

SDK çš„æ‰“åŒ…éå¸¸ç®€å•ï¼Œé€šè¿‡ Maven çš„ install å‘½ä»¤å³å¯ï¼ŒSDK çš„ jar åŒ…å°±ä¼šè¢«å¯¼å…¥åˆ°ä½ çš„æœ¬åœ°ä»“åº“ä¸­ã€‚

> åœ¨æ‰“åŒ…å‰å»ºè®®å…ˆæ‰§è¡Œ clean æ¥æ¸…ç†åƒåœ¾æ–‡ä»¶ã€‚ 

![](https://yupi-picture-1256524210.cos.ap-shanghai.myqcloud.com/1/1697194173045-c3c994f0-9415-40f0-886a-5bc41cba9576.png)

### 7ã€è°ƒç”¨ SDK

æœ€åæˆ‘ä»¬æ¥è°ƒç”¨è‡ªå·±å†™çš„ SDKï¼Œé¦–å…ˆå°†ä½ çš„ SDK ä½œä¸ºä¾èµ–å¼•å…¥åˆ°é¡¹ç›®ä¸­ï¼Œæ¯”å¦‚æˆ‘ä»¬çš„æ¥æ°´æé†’åº”ç”¨ã€‚

å¼•å…¥ä»£ç å¦‚ä¸‹ï¼š

```xml
<dependency>
  <groupId>com.yupi</groupId>
  <artifactId>rtx-robot</artifactId>
  <version>1.0-SNAPSHOT</version>
</dependency>
```

ç„¶åå°†ä¹‹å‰å¤åˆ¶çš„ webhook å†™å…¥åˆ° Spring Boot çš„é…ç½®æ–‡ä»¶ä¸­ï¼š

```yaml
wechatwork-bot:
  webhook: ä½ çš„webhookåœ°å€
```

éšåä½ å°±å¯ä»¥ç”¨ä¾èµ–æ³¨å…¥çš„æ–¹å¼å¾—åˆ°ä¸€ä¸ªæ¶ˆæ¯å‘é€è€…å¯¹è±¡äº†ï¼š

```java
@Resource
public RtxRobotMessageSender rtxRobotMessageSender;
```

å½“ç„¶ä½ ä¹Ÿå¯ä»¥é€‰æ‹©åœ¨ä¸€ä¸ªé Spring ç¯å¢ƒä¸­æ‰‹åŠ¨åˆ›å»ºå¯¹è±¡ï¼Œè‡ªå·±ä¼ å…¥ webhookï¼š

```java
String webhook = "ä½ çš„webhookåœ°å€";
RtxRobotMessageSender rtxRobotMessageSender = new RtxRobotMessageSender(webhook);
```

ç°åœ¨ï¼Œå°±å¯ä»¥è½»æ¾å®ç°æˆ‘ä»¬ä¹‹å‰æåˆ°çš„æé†’æ¥æ°´å·¥å…·äº†ã€‚

è¿™é‡Œæˆ‘ä»¬å°±ç”¨æœ€ç®€å•çš„æ–¹å¼ï¼Œå®šä¹‰ä¸€ä¸ªå‘˜å·¥æ•°ç»„ï¼Œåˆ†åˆ«å¯¹åº”åˆ°æ¯å‘¨ Xï¼Œç„¶åç”¨å®šæ—¶ä»»åŠ¡æ¯æ—¥æ‰§è¡Œæ¶ˆæ¯å‘é€ã€‚

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
@Component
public class WaterReminderTask {

    @Resource
    public RtxRobotMessageSender rtxRobotMessageSender;

    private String[] names = {"å‘˜å·¥a", "å‘˜å·¥b", "å‘˜å·¥c", "å‘˜å·¥d", "å‘˜å·¥e"};

    @Scheduled(cron = "0 55 9 * * MON-FRI")
    public void remindToGetWater() {
        LocalDate today = LocalDate.now();
        DayOfWeek dayOfWeek = today.getDayOfWeek();
        String nameToRemind;
        switch (dayOfWeek) {
            case MONDAY:
                nameToRemind = names[0];
                break;
            case TUESDAY:
                nameToRemind = names[1];
                break;
            case WEDNESDAY:
                nameToRemind = names[2];
                break;
            case THURSDAY:
                nameToRemind = names[3];
                break;
            case FRIDAY:
                nameToRemind = names[4];
                break;
            default:
                return;
        }
      
        String message = "æé†’ï¼š" + nameToRemind + "ï¼Œæ˜¯ä½ æ¥æ°´çš„æ—¶é—´äº†ï¼";
        rtxRobotMessageSender.sendText(message);
    }
}
```



å¥½äº†ï¼Œç°åœ¨å¤§å®¶æ¯å¤©éƒ½æœ‰æ°´å–äº†ï¼ŒçœŸä¸é”™ ğŸ‘ğŸ»

![](https://yupi-picture-1256524210.cos.ap-shanghai.myqcloud.com/1/image-20231014154348045.png)



## æœ€å

è™½ç„¶å¼€å‘ä¼å¾®æœºå™¨äºº SDK å¹¶ä¸éš¾ï¼Œä½†æƒ³åšä¸€ä¸ªå®Œå–„çš„ã€æ˜“ç”¨çš„ SDK è¿˜æ˜¯éœ€è¦ä¸¤æŠŠåˆ·å­çš„ï¼Œè€Œä¸”æ²‰æ·€ SDK å¯¹è‡ªå·±æœªæ¥åšé¡¹ç›®å¸®åŠ©ä¼šéå¸¸å¤§ã€‚

å¸Œæœ›æœ¬æ–‡å¯¹å¤§å®¶æœ‰å¸®åŠ©ï¼Œå­¦ä¼šçš„è¯ `ç‚¹ä¸ªèµ`  æˆ– `åœ¨çœ‹` å§ï¼Œè°¢è°¢å¤§å®¶~

