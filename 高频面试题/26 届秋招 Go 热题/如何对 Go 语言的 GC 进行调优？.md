## 如何对 Go 语言的 GC 进行调优？
> 八股文一网打尽，更多面试题请看[程序员面试刷题神器 - 面试鸭](https://www.mianshiya.com/)

## 回答重点 

主要是通过合理设置GC的策略与参数，来降低垃圾回收对程序性能的影响，使得内存管理变得更加简单。**调优是一个反复迭代的过程，持续监控和分析是关键。**

GC 调优，主要是两方面：一方面减少用户代码分配内存的数量（即对程序的代码行为进行调优），另一方面最小化 Go 的 GC 对 CPU 的使用率（即调整 GOGC）。

GO 进行 GC 调优有以下几个主要方式：

1）配置 GOGC ，控制触发 GC 的内存增长百分比，降低 GC 的频率。

2）优化内存分配和释放，减少 go 对象分配和释放的频率。控制内存分配的速度，比如限制 Goroutine 的数量。

3）调整数据结构和算法，比如减少指针的使用，再比如少量使用＋连接 string ，避免重复扩容，再比如使用slice时提前分配足够的内存来降低扩容带来的拷贝。

4）更新GO版本，利用最新的性能改进和垃圾回收优化。

5）对于长时间运行的批处理任务等，可以使用 runtime.GC() 或 debug.FreeOSMemory() 来可以强制触发GC。
 

## 扩展知识

1）了解GC的工作原理

在开始调优之前，了解Go的GC工作原理是非常有帮助的。Go的GC是基于三色标记-清除算法的，并且是并行的、增量式的和低停顿时间的。GC的主要目标是减少程序因GC暂停而产生的停顿时间。

注意，GC 的调优是在特定场景下产生的，并非所有程序都需要针对 GC 进行调优。只有那些对执行延迟非常敏感、当 GC 的开销成为程序性能瓶颈的程序，才需要针对 GC 进行性能调优，几乎不存在于实际开发中 99% 的情况。

2） 使用环境变量调整GC参数

Go的垃圾回收器可以通过环境变量进行配置，例如`GOGC`和`GODEBUG`。

**GOGC**：控制触发GC的内存增长百分比。默认值为100，这意味着当堆内存增长到当前堆内存的两倍时触发GC。增大`GOGC`值会减少GC的频率，但可能会增加内存使用。

```sh
export GOGC=200
```
    
或者在代码里
```go
debug.SetGCPercent(200)
```

**GODEBUG**：可以控制和调试垃圾回收行为。常用的选项包括：

    - `gctrace=1`：启用GC跟踪，显示每次GC的详细信息。
    - `gcstoptheworld=1`：让GC在一个stop-the-world模式下运行，用于调试。
    - `garbagecollection=off`：禁用GC，用于调试。


3）优化内存分配和释放

减少内存分配和释放的频率可以减少GC的负担：

**复用对象**：使用对象池（例如`sync.Pool`）可以减少频繁的新对象分配。
```go
    var bufPool = sync.Pool{
        New: func() interface{} {
            return new(bytes.Buffer)
        },
    }

    func main() {
        buf := bufPool.Get().(*bytes.Buffer)
        buf.Reset()
        // 使用buf
        bufPool.Put(buf)
    }
 ```

**避免短命对象**：尽量减少短命对象的创建，它们会增加GC的频率。可以通过预分配大块内存并重复使用来避免频繁分配和释放小对象。

4） 监控和分析GC性能

使用`pprof`和`trace`工具来监控和分析GC的性能：

**CPU分析**：检查GC的CPU使用情况。

```sh
go tool pprof http://localhost:6060/debug/pprof/profile
```

**内存分析**：查看内存分配情况。

```sh
go tool pprof http://localhost:6060/debug/pprof/heap
```

**GC跟踪**：启用GC跟踪，查看每次GC的详细信息。

```sh
export GODEBUG=gctrace=1
```

5） 调整数据结构和算法

选择合适的数据结构和算法也可以减少内存分配：

**减少引用类型的使用**：例如，尽量使用值类型而不是指针类型，这样可以减少对小对象的分配和垃圾回收。

**批量处理**：如果可能，尽量将一些零散的处理合并成批量处理，减少内存分配次数。

6） 调整GC触发的阈值

通过程序代码动态调整`GOGC`值，可以在程序运行的不同阶段进行不同的调优：

```go
debug.SetGCPercent(200)
```

7） 使用新特性

Go语言不断演进，垃圾回收机制也在不断改进。因此记得升级最新版本的go，以便利用最新的性能改进和垃圾回收优化。

8） 分析内存分配热点

使用`pprof`生成内存分配热点图，找出内存分配的热点位置，并进行优化：

```sh
go tool pprof -alloc_space http://localhost:6060/debug/pprof/heap
```

9）不要频繁手动 GC，原因有三：

因为强制多次进行垃圾回收会带来一定的性能开销。

因为频繁调用 debug.FreeOSMemory() 可能会频繁地释放内存给操作系统，但实际上这些内存可能很快会被重新分配，导致性能下降。

因为 Go 的 GC 已经经过很好的调优和优化，通常情况下不需要人工干预。强制调用垃圾回收可能破坏 GC 的调优效果。

### 实际案例

当一个高并发的 HTTP 服务， GC 频繁影响了响应时延。通过增加 GOGC 值，使得 GC 尽量延后，但注意不要增加太多，导致内存暴增。结合使用 pprof .观察效果，发现每次 GC 暂停时间明显下降，总体延迟改善。

> 八股文一网打尽，更多面试题请看[程序员面试刷题神器 - 面试鸭](https://www.mianshiya.com/)