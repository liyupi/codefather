## 为什么 JDK 1.8 对 HashMap 进行了红黑树的改动？
> 八股文一网打尽，更多面试题请看[程序员面试刷题神器 - 面试鸭](https://www.mianshiya.com/)

## 回答重点

在 JDK 1.8 之前，`HashMap` 使用链表来解决哈希冲突。当哈希冲突较多时，链表中的元素增多，查找、插入和删除的时间复杂度从 O(1) 退化为 O(n)。

因此在 JDK 1.8 引入红黑树，将链表长度超过一定阈值（默认 8）时的链表转换为红黑树，避免性能急剧下降。当链表长度降到 6 以下时，红黑树会重新退化为链表，保持简单高效。

红黑树是一种平衡二叉搜索树，插入、删除、查找操作的时间复杂度为 O(log n)，在元素多的情况下远优于链表的 O(n)。

## 扩展知识

### **链表与红黑树的转换时机**

除了链表长度影响树化，实际上还与数组长度有关。

**链表到红黑树的转换机制**：
 - 如果某个桶中的元素数量**大于等于** 8，且数组长度**大于等于** 64 时，链表转换为红黑树；
 - 如果数组长度小于 64，则选择扩容而不是转换为红黑树。

`binCount` 从 0 开始计算，大于等于 7 则触发 `treeifyBin`（树化方法）：

<img src="https://pic.code-nav.cn/mianshiya/question_picture/1783388929455529986/9ksKxXIh_image_mianshiya.png" alt="image.png" width="100%" />

`treeifyBin` 内还需判断数组的大小：


<img src="https://pic.code-nav.cn/mianshiya/question_picture/1783388929455529986/neWKcf70_image_mianshiya.png" alt="image.png" width="100%" />

### 为什么数组要大于等于 64 才转红黑树？

主要原因有以下两点：
- 避免频繁的树化
- 减少内存占用

当数组容量较小的时候，哈希冲突大，但是扩容后的 HashMap 自然会减少哈希冲突。如果在小数组上过早地进行链表转红黑树，可能会因为很快的扩容导致不必要的树化开销。

刚树化了没多久就扩容了，冲突就少了，此时不就白白树化了？所以设计上设置了数组大小需要大于 64 才允许链表转为红黑树，防止频繁的树化。

红黑树相比链表需要更多的内存，尤其是在节点较少的情况下，红黑树的额外指针和结构占用更大。为了节省内存，HashMap 选择只有在数组容量达到一定规模后才树化，防止红黑树在小规模数据中带来额外的内存负担。

### 不能抛弃链表，直接使用红黑树吗？

来看下源码的注释:
<p align="center"><img src="https://pic.code-nav.cn/mianshiya/question_picture/1783397053004488705/20220219202947.png" alt="20220219202947.png" width="569" /></p>

因为**红黑树节点的大小是普通节点大小的两倍**，所以为了节省内存空间不会直接只用红黑树，只有当节点到达一定数量才会转成红黑树，这里定义的是 8。

为什么是 8 呢？这个其实 HashMap 注释上也有说，和泊松分布有关系。

<p align="center"><img src="https://pic.code-nav.cn/mianshiya/question_picture/1783397053004488705/20220219202956_mianshiya.png" alt="20220219202956.png" width="496" /></p>

简单翻译下就是在默认阈值是 0.75 的情况下，冲突节点长度为 8 的概率为 0.00000006，也就概率比较小（毕竟红黑树耗内存，且链表长度短点时遍历的还是很快的）。

这就是基于时间和空间的平衡了，红黑树占用内存大，所以节点少就不用红黑树，如果万一真的冲突很多，就用红黑树，选个参数为 8 的大小，就是为了平衡时间和空间的问题。

### 为什么节点小于等于 6 要从红黑树转成链表？

链表树化的节点是 8，除此之外，当树节点数小于等于 6 时候，又会从红黑树转为链表。

这个操作是为了平衡时间和空间，节点太少链表遍历也很快，没必要成红黑树，变成链表节约内存。

为什么定了 6 而不是小于等于 8 就变？

是因为要留个缓冲余地，避免反复横跳。举个例子，一个节点反复添加，从 8 变成 9 ，链表变红黑树，又删了，从 9 变成 8，又从红黑树变链表，再添加，又从链表变红黑树？

所以余一点，毕竟树化和反树化都是有开销的。

### TreeMap 和红黑树

- [458. 什么是 Java 的 TreeMap？ ](https://www.mianshiya.com/bank/1788408712975282177/question/1780933294796337153)

> 八股文一网打尽，更多面试题请看[程序员面试刷题神器 - 面试鸭](https://www.mianshiya.com/)