# ä½¿ç”¨å¯¹è±¡å­˜å‚¨å®ç°æ–‡ä»¶ä¸Šä¼ ä¸‹è½½

> ä½œè€…ï¼š[ç¨‹åºå‘˜é±¼çš®](https://space.bilibili.com/12890453/)ï¼Œ[ç¼–ç¨‹å¯¼èˆª](https://yuyuanweb.feishu.cn/wiki/VC1qwmX9diCBK3kidyec74vFnde) ç¼–å· 1



## åŸºæœ¬æ€è·¯

é¦–å…ˆæˆ‘ä»¬è¦æ€è€ƒï¼šå°†æ–‡ä»¶ä¸Šä¼ åˆ°å“ªé‡Œï¼Ÿä»å“ªé‡Œä¸‹è½½ï¼Ÿ

æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯ä¸Šä¼ åˆ°åç«¯é¡¹ç›®æ‰€åœ¨çš„æœåŠ¡å™¨ï¼Œç›´æ¥ä½¿ç”¨ Java è‡ªå¸¦çš„æ–‡ä»¶è¯»å†™ API å°±èƒ½å®ç°ã€‚ä½†æ˜¯ï¼Œè¿™ç§æ–¹å¼å­˜åœ¨ä¸å°‘ç¼ºç‚¹ï¼Œæ¯”å¦‚ï¼š

1. ä¸åˆ©äºæ‰©å±•ï¼šå•ä¸ªæœåŠ¡å™¨çš„å­˜å‚¨æ˜¯æœ‰é™çš„ï¼Œå¦‚æœå­˜æ»¡äº†ï¼Œåªèƒ½å†æ–°å¢å­˜å‚¨ç©ºé—´æˆ–è€…æ¸…ç†æ–‡ä»¶ã€‚
2. ä¸åˆ©äºè¿ç§»ï¼šå¦‚æœåç«¯é¡¹ç›®è¦æ›´æ¢æœåŠ¡å™¨éƒ¨ç½²ï¼Œä¹‹å‰æ‰€æœ‰çš„æ–‡ä»¶éƒ½è¦è¿ç§»åˆ°æ–°æœåŠ¡å™¨ï¼Œéå¸¸éº»çƒ¦ã€‚
3. ä¸å¤Ÿå®‰å…¨ï¼šå¦‚æœå¿˜è®°æ§åˆ¶æƒé™ï¼Œç”¨æˆ·å¾ˆæœ‰å¯èƒ½é€šè¿‡æ¶æ„ä»£ç è®¿é—®æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶ï¼Œè€Œä¸”æƒ³æ§åˆ¶æƒé™ä¹Ÿæ¯”è¾ƒéº»çƒ¦ï¼Œéœ€è¦è‡ªå·±å®ç°ã€‚
4. ä¸åˆ©äºç®¡ç†ï¼šåªèƒ½é€šè¿‡ä¸€äº›æ–‡ä»¶ç®¡ç†å™¨è¿›è¡Œç®€å•çš„ç®¡ç†æ“ä½œï¼Œä½†æ˜¯ç¼ºä¹æ•°æ®å¤„ç†ã€æµé‡æ§åˆ¶ç­‰å¤šç§é«˜çº§èƒ½åŠ›ã€‚



å› æ­¤ï¼Œé™¤äº†å­˜å‚¨ä¸€äº›éœ€è¦æ¸…ç†çš„ä¸´æ—¶æ–‡ä»¶ä¹‹å¤–ï¼Œæˆ‘ä»¬é€šå¸¸ä¸ä¼šå°†ç”¨æˆ·ä¸Šä¼ å¹¶ä¿å­˜çš„æ–‡ä»¶ï¼ˆæ¯”å¦‚ç”¨æˆ·å¤´åƒï¼‰ç›´æ¥ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œè€Œæ˜¯æ›´æ¨èå¤§å®¶ä½¿ç”¨ä¸“ä¸šçš„ç¬¬ä¸‰æ–¹å­˜å‚¨æœåŠ¡ï¼Œä¸“ä¸šçš„å·¥å…·åšä¸“ä¸šçš„äº‹ã€‚å…¶ä¸­ï¼Œæœ€å¸¸ç”¨çš„ä¾¿æ˜¯ **å¯¹è±¡å­˜å‚¨** ã€‚



## ä»€ä¹ˆæ˜¯å¯¹è±¡å­˜å‚¨ï¼Ÿ

å¯¹è±¡å­˜å‚¨æ˜¯ä¸€ç§å­˜å‚¨ **æµ·é‡æ–‡ä»¶** çš„ **åˆ†å¸ƒå¼** å­˜å‚¨æœåŠ¡ï¼Œå…·æœ‰é«˜æ‰©å±•æ€§ã€ä½æˆæœ¬ã€å¯é å®‰å…¨ç­‰ä¼˜ç‚¹ã€‚

æ¯”å¦‚å¼€æºçš„å¯¹è±¡å­˜å‚¨æœåŠ¡ MinIOï¼Œè¿˜æœ‰å•†ä¸šç‰ˆçš„äº‘æœåŠ¡ï¼Œåƒäºšé©¬é€Š S3ï¼ˆAmazon S3ï¼‰ã€é˜¿é‡Œäº‘å¯¹è±¡å­˜å‚¨ï¼ˆOSSï¼‰ã€è…¾è®¯äº‘å¯¹è±¡å­˜å‚¨ï¼ˆCOSï¼‰ç­‰ç­‰ã€‚

æˆ‘ä¸ªäººæ›´æ¨èå¤§å®¶ä½¿ç”¨ç¬¬ä¸‰æ–¹äº‘æœåŠ¡ï¼Œä¸è¦è‡ªå·±å†å»æ­å»º MinIO ä¹‹ç±»çš„ï¼Œå’±å­¦ä¹ ä¸»æ‰“ä¸€ä¸ªå¿«é€Ÿï¼

é±¼çš®ä½¿ç”¨æœ€å¤šçš„å¯¹è±¡å­˜å‚¨æœåŠ¡å½“å±è…¾è®¯äº‘çš„ COS äº†ï¼Œé™¤äº†åŸºæœ¬çš„å¯¹è±¡å­˜å‚¨çš„ä¼˜ç‚¹å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡æ§åˆ¶å°ã€APIã€SDK å’Œå·¥å…·ç­‰å¤šæ ·åŒ–æ–¹å¼ï¼Œç®€å•å¿«é€Ÿåœ°æ¥å…¥ COSï¼Œè¿›è¡Œå¤šæ ¼å¼æ–‡ä»¶çš„ä¸Šä¼ ã€ä¸‹è½½å’Œç®¡ç†ï¼Œå®ç°æµ·é‡æ•°æ®å­˜å‚¨å’Œç®¡ç†ã€‚

æœ¬æ•™ç¨‹ä¸­ï¼Œå°†ç”¨è…¾è®¯äº‘çš„ COS å¸¦å¤§å®¶å®ç°æ–‡ä»¶çš„ä¸Šä¼ å’Œä¸‹è½½ã€‚é±¼çš®ä¹‹å‰æ­å»ºçš„å›¾åºŠå°±æ˜¯ä½¿ç”¨äº† COS å¯¹è±¡å­˜å‚¨å®ç°ï¼Œå¾ˆç®€å•ã€‚



## åˆ›å»ºå¹¶ä½¿ç”¨

é¦–å…ˆè¿›å…¥å¯¹è±¡å­˜å‚¨çš„æ§åˆ¶å°ï¼Œåˆ›å»ºå­˜å‚¨æ¡¶ã€‚

> åœ°å€ï¼šhttps://console.cloud.tencent.com/cos/bucket



å¯ä»¥æŠŠå­˜å‚¨æ¡¶ç†è§£ä¸ºä¸€ä¸ªå­˜å‚¨ç©ºé—´ï¼Œå’Œæ–‡ä»¶ç³»ç»Ÿç±»ä¼¼ï¼Œéƒ½æ˜¯æ ¹æ®è·¯å¾„æ‰¾åˆ°æ–‡ä»¶æˆ–ç›®å½•ï¼ˆæ¯”å¦‚ `/test/aaa.jpg`ï¼‰ã€‚å¯ä»¥å¤šä¸ªé¡¹ç›®å…±ç”¨ä¸€ä¸ªå­˜å‚¨æ¡¶ï¼Œä¹Ÿå¯ä»¥æ¯ä¸ªé¡¹ç›®ä¸€ä¸ªã€‚

ç‚¹å‡»åˆ›å»ºå­˜å‚¨æ¡¶ï¼Œæ³¨æ„åœ°åŸŸé€‰æ‹©å›½å†…ï¼ˆç¦»ç”¨æˆ·è¾ƒè¿‘çš„ä½ç½®ï¼‰ã€‚æ­¤å¤„è®¿é—®æƒé™å…ˆé€‰æ‹©â€œå…¬æœ‰è¯»ç§æœ‰å†™â€ï¼Œå› ä¸ºæˆ‘ä»¬çš„å­˜å‚¨æ¡¶è¦å­˜å‚¨å…è®¸ç”¨æˆ·å…¬å¼€è®¿é—®çš„ä»£ç ç”Ÿæˆå™¨å›¾ç‰‡ã€‚è€Œå¦‚æœæ•´ä¸ªå­˜å‚¨æ¡¶è¦å­˜å‚¨çš„æ–‡ä»¶éƒ½ä¸å…è®¸ç”¨æˆ·è®¿é—®ï¼Œå»ºè®®é€‰æ‹©ç§æœ‰è¯»å†™ï¼Œæ›´å®‰å…¨ã€‚

é»˜è®¤å‘Šè­¦ä¸€å®šè¦å‹¾é€‰ï¼å› ä¸ºå¯¹è±¡å­˜å‚¨æœåŠ¡çš„å­˜å‚¨å’Œè®¿é—®æµé‡éƒ½æ˜¯è®¡è´¹çš„ï¼Œè¶…é™åæˆ‘ä»¬è¦ç¬¬ä¸€æ—¶é—´å¾—åˆ°é€šçŸ¥å¹¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚

ä¸è¿‡ä¹Ÿä¸ç”¨å¤ªæ‹…å¿ƒï¼Œè‡ªå·±åšé¡¹ç›®çš„è¯ä¸€èˆ¬æ˜¯æ²¡äººæ”»å‡»ä½ çš„ï¼Œè€Œä¸”å¯¹è±¡å­˜å‚¨å¾ˆä¾¿å®œï¼Œæ­£å¸¸æƒ…å†µä¸‹æ¶ˆè€—çš„è´¹ç”¨å¯¥å¯¥æ— å‡ ã€‚

![img](https://pic.yupi.icu/1/1704268636685-dd04d842-288e-4b5a-8426-c0ea28341173.png)



ç„¶åä¸€ç›´ç‚¹å‡»â€œä¸‹ä¸€æ­¥â€å³å¯ï¼š

![img](https://pic.yupi.icu/1/1704269039939-a04c94b4-f44a-4a2e-9e04-0d83b53d831a.png)

![img](https://pic.yupi.icu/1/1703836008241-8b8770e2-4cb7-443b-97ef-616592c1a561.png)



å¼€é€šæˆåŠŸåï¼Œæˆ‘ä»¬å¯ä»¥è¯•ç€ä½¿ç”¨ web æ§åˆ¶å°ä¸Šä¼ å’Œæµè§ˆæ–‡ä»¶ï¼š

![img](https://pic.yupi.icu/1/1704269104675-63ddbf4f-7990-4c28-bb84-4872cbd68768.png)



ä¸Šä¼ æ–‡ä»¶åï¼Œå¯ä»¥ä½¿ç”¨å¯¹è±¡å­˜å‚¨æœåŠ¡ä¸ºæˆ‘ä»¬ç”Ÿæˆçš„é»˜è®¤åŸŸåï¼Œåœ¨çº¿è®¿é—®å›¾ç‰‡ï¼š

![img](https://pic.yupi.icu/1/1704269144547-9faa7322-f89b-47d7-ba2e-dd1c61f65b8b.png)



å½“ç„¶ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä¼šä½¿ç”¨ç¨‹åºæ¥æ“ä½œå­˜å‚¨æ¡¶ï¼Œä¸‹é¢å°±æ¥å®ç°ã€‚



## åç«¯æ“ä½œå¯¹è±¡å­˜å‚¨

å¦‚ä½•åœ¨ Java ç¨‹åºä¸­ä½¿ç”¨å¯¹è±¡å­˜å‚¨å‘¢ï¼Ÿ

å…¶å®éå¸¸ç®€å•ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç¬¬ä¸‰æ–¹æœåŠ¡éƒ½ä¼šæä¾›æ¯”è¾ƒè´´å¿ƒçš„æ–‡æ¡£æ•™ç¨‹ï¼Œæ¯”å¦‚è¿™é‡Œæˆ‘ä»¬å‚è€ƒå®˜æ–¹çš„å¿«é€Ÿå…¥é—¨æˆ– Java SDK æ–‡æ¡£ï¼Œå°±èƒ½å¿«é€Ÿå…¥é—¨åŸºæœ¬æ“ä½œï¼ˆå¢åˆ æ”¹æŸ¥éƒ½æœ‰ï¼‰ã€‚

æ–‡æ¡£åœ°å€ï¼šhttps://cloud.tencent.com/document/product/436/10199



è¿˜æœ‰æ›´é«˜çº§çš„å­¦ä¹ æ“ä½œæ–¹æ³•ï¼Œå¦‚æœä½ æ˜¯è…¾è®¯äº‘ç†Ÿç»ƒç”¨æˆ·ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ API Explorerï¼Œåœ¨çº¿å¯»æ‰¾æ“ä½œå’Œç¤ºä¾‹ä»£ç ã€‚

åœ°å€ï¼šhttps://console.cloud.tencent.com/api/explorer?Product=cos&Version=2018-11-26&Action=PutBucket



![img](https://pic.yupi.icu/1/1703831535805-326f18b5-b20c-4400-87d5-d2db5827add4.png)



#### 1ã€åˆå§‹åŒ–å®¢æˆ·ç«¯

å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼Œæˆ‘ä»¬è¦å…ˆåˆå§‹åŒ–ä¸€ä¸ª COS å®¢æˆ·ç«¯å¯¹è±¡ï¼Œå’Œå¯¹è±¡å­˜å‚¨æœåŠ¡è¿›è¡Œäº¤äº’ã€‚

![img](https://pic.yupi.icu/1/1703831413427-5e564618-6d4b-464b-aa34-28fda26fdd00.png)



å¯¹äºæˆ‘ä»¬çš„é¡¹ç›®ï¼Œåªéœ€è¦å¤ç”¨ä¸€ä¸ª COS å®¢æˆ·ç«¯å¯¹è±¡å³å¯ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ç¼–å†™é…ç½®ç±»åˆå§‹åŒ–å®¢æˆ·ç«¯å¯¹è±¡ã€‚

1ï¼‰æ‰“å¼€ `yuzi-generator-web-backend` é¡¹ç›®ï¼Œåœ¨ config ç›®å½•ä¸‹æ–°å»º `CosClientConfig` ç±»ã€‚è´Ÿè´£è¯»å–é…ç½®æ–‡ä»¶ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª COS å®¢æˆ·ç«¯çš„ Beanã€‚

åç«¯ä¸‡ç”¨æ¨¡æ¿ä¸­å·²ç»æ•´åˆäº†è¯¥æ–‡ä»¶ï¼Œä¸ç”¨è‡ªå·±ç¼–å†™ã€‚



ä»£ç å¦‚ä¸‹ï¼š

```java
@Configuration
@ConfigurationProperties(prefix = "cos.client")
@Data
public class CosClientConfig {

    /**
     * accessKey
     */
    private String accessKey;

    /**
     * secretKey
     */
    private String secretKey;

    /**
     * åŒºåŸŸ
     */
    private String region;

    /**
     * æ¡¶å
     */
    private String bucket;

    @Bean
    public COSClient cosClient() {
        // åˆå§‹åŒ–ç”¨æˆ·èº«ä»½ä¿¡æ¯(secretId, secretKey)
        COSCredentials cred = new BasicCOSCredentials(accessKey, secretKey);
        // è®¾ç½®bucketçš„åŒºåŸŸ, COSåœ°åŸŸçš„ç®€ç§°è¯·å‚ç…§ https://www.qcloud.com/document/product/436/6224
        ClientConfig clientConfig = new ClientConfig(new Region(region));
        // ç”Ÿæˆcoså®¢æˆ·ç«¯
        return new COSClient(cred, clientConfig);
    }
}
```



2ï¼‰å¡«å†™é…ç½®æ–‡ä»¶ã€‚

**ä¸€å®šè¦æ³¨æ„é˜²æ­¢å¯†ç æ³„éœ²ï¼** æ‰€ä»¥æˆ‘ä»¬æ–°å»º `application-local.yml` æ–‡ä»¶ï¼Œå¹¶ä¸”åœ¨ `.gitignore` ä¸­å¿½ç•¥è¯¥æ–‡ä»¶çš„æäº¤ï¼Œè¿™æ ·å°±ä¸ä¼šå°†ä»£ç ç­‰æ•æ„Ÿé…ç½®æäº¤åˆ°ä»£ç ä»“åº“äº†ã€‚

é…ç½®ä»£ç å¦‚ä¸‹ï¼š

```yaml
# æœ¬åœ°é…ç½®æ–‡ä»¶
# å¯¹è±¡å­˜å‚¨
cos:
  client:
    accessKey: xxx
    secretKey: xxx
    region: xxx
    bucket: xxx
```



å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼åˆ†åˆ«è·å–éœ€è¦çš„é…ç½®ã€‚

accessKeyã€secretKey å¯†é’¥å¯¹ï¼šåœ¨è…¾è®¯äº‘è®¿é—®ç®¡ç† => å¯†é’¥ç®¡ç†ä¸­è·å–ã€‚

åœ°å€ï¼šhttps://console.cloud.tencent.com/cam/capi

![img](https://pic.yupi.icu/1/1704270078483-26dbf154-08b6-4ee6-b4ca-30a109cba482.png)



region è¡¨ç¤ºåœ°åŸŸåï¼Œå¯ä»¥ç‚¹æ­¤è·å–ï¼šhttps://cloud.tencent.com/document/product/436/6224

bucket æ˜¯å­˜å‚¨æ¡¶åï¼Œå¯ä»¥è½»æ¾è·å–ï¼š

![img](https://pic.yupi.icu/1/1704270222606-2c4ba19b-9378-4683-8335-6cfb0810afed.png)



#### 2ã€é€šç”¨èƒ½åŠ›ç±»

åœ¨ `com.yupi.web.manager` åŒ…ä¸‹æ–°å»º `CosManager` ç±»ï¼Œæä¾›é€šç”¨çš„å¯¹è±¡å­˜å‚¨æ“ä½œï¼Œæ¯”å¦‚æ–‡ä»¶ä¸Šä¼ ã€æ–‡ä»¶ä¸‹è½½ç­‰ï¼Œä¾›å…¶ä»–ä»£ç ï¼ˆæ¯”å¦‚ Serviceï¼‰è°ƒç”¨ã€‚

è¯¥ç±»éœ€è¦å¼•å…¥å¯¹è±¡å­˜å‚¨é…ç½®å’Œ COS å®¢æˆ·ç«¯ï¼Œç”¨äºå’Œ COS è¿›è¡Œäº¤äº’ã€‚ä»£ç å¦‚ä¸‹ï¼š

åç«¯ä¸‡ç”¨æ¨¡æ¿ä¸­å·²ç»æ•´åˆäº†è¯¥æ–‡ä»¶ï¼Œä¸ç”¨è‡ªå·±ç¼–å†™ã€‚



```java
@Component
public class CosManager {

    @Resource
    private CosClientConfig cosClientConfig;

    @Resource
    private COSClient cosClient;

    ... ä¸€äº›æ“ä½œ COS çš„æ–¹æ³•
}
```



#### 3ã€æ–‡ä»¶ä¸Šä¼ 

å‚è€ƒå®˜æ–¹æ–‡æ¡£çš„â€œä¸Šä¼ å¯¹è±¡â€éƒ¨åˆ†ï¼Œå¯ä»¥ç¼–å†™å‡ºæ–‡ä»¶ä¸Šä¼ çš„ä»£ç ã€‚

åœ°å€ï¼šhttps://cloud.tencent.com/document/product/436/65935



1ï¼‰`CosManager` æ–°å¢ä¸¤ä¸ªä¸Šä¼ å¯¹è±¡çš„æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
@Component
public class CosManager {

    @Resource
    private CosClientConfig cosClientConfig;

    @Resource
    private COSClient cosClient;

    /**
     * ä¸Šä¼ å¯¹è±¡
     *
     * @param key           å”¯ä¸€é”®
     * @param localFilePath æœ¬åœ°æ–‡ä»¶è·¯å¾„
     * @return
     */
    public PutObjectResult putObject(String key, String localFilePath) {
        PutObjectRequest putObjectRequest = new PutObjectRequest(
            cosClientConfig.getBucket(), key, new File(localFilePath));
        return cosClient.putObject(putObjectRequest);
    }

    /**
     * ä¸Šä¼ å¯¹è±¡
     *
     * @param key  å”¯ä¸€é”®
     * @param file æ–‡ä»¶
     * @return
     */
    public PutObjectResult putObject(String key, File file) {
        PutObjectRequest putObjectRequest = new PutObjectRequest(
            cosClientConfig.getBucket(), key, file);
        return cosClient.putObject(putObjectRequest);
    }
}
```



2ï¼‰ä¿®æ”¹ `FileConstant` å¸¸é‡ä¸­çš„ COS è®¿é—®åŸŸåï¼Œä¾¿äºæ¥ä¸‹æ¥æµ‹è¯•è®¿é—®å·²ä¸Šä¼ çš„æ–‡ä»¶ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```java
package com.yupi.web.constant;

/**
 * æ–‡ä»¶å¸¸é‡
 *
 * @author <a href="https://github.com/liyupi">ç¨‹åºå‘˜é±¼çš®</a>
 * @from <a href="https://yupi.icu">ç¼–ç¨‹å¯¼èˆª</a>
 */
public interface FileConstant {

    /**
     * COS è®¿é—®åœ°å€
     * todo éœ€æ›¿æ¢é…ç½®
     */
    String COS_HOST = "https://yuzi-1256524210.cos.ap-shanghai.myqcloud.com";
}
```



è¯¥åŸŸåå¯ä»¥åœ¨ COS æ§åˆ¶å°çš„åŸŸåä¿¡æ¯éƒ¨åˆ†æ‰¾åˆ°ï¼š

![img](https://pic.yupi.icu/1/1704184533040-3be9bb18-d4da-471d-bcf8-df2cbea1eed8.png)



3ï¼‰ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œåœ¨ `FileController` ä¸­ç¼–å†™æµ‹è¯•æ–‡ä»¶ä¸Šä¼ æ¥å£ã€‚

æ ¸å¿ƒæµç¨‹æ˜¯å…ˆæ¥å—ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶ï¼ŒæŒ‡å®šä¸Šä¼ çš„è·¯å¾„ï¼Œç„¶åè°ƒç”¨ `cosManager.putObject` æ–¹æ³•ä¸Šä¼ æ–‡ä»¶åˆ° COS å¯¹è±¡å­˜å‚¨ï¼›ä¸Šä¼ æˆåŠŸåï¼Œä¼šè¿”å›ä¸€ä¸ªæ–‡ä»¶çš„ keyï¼ˆå…¶å®å°±æ˜¯æ–‡ä»¶è·¯å¾„ï¼‰ï¼Œä¾¿äºæˆ‘ä»¬è®¿é—®å’Œä¸‹è½½æ–‡ä»¶ã€‚

éœ€è¦æ³¨æ„ï¼Œæµ‹è¯•æ¥å£ä¸€å®šè¦åŠ ä¸Šç®¡ç†å‘˜æƒé™ï¼é˜²æ­¢ä»»ä½•ç”¨æˆ·éšæ„ä¸Šä¼ æ–‡ä»¶ã€‚

æµ‹è¯•æ–‡ä»¶ä¸Šä¼ æ¥å£ä»£ç å¦‚ä¸‹ï¼š

```java
/**
 * æµ‹è¯•æ–‡ä»¶ä¸Šä¼ 
 *
 * @param multipartFile
 * @return
 */
@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
@PostMapping("/test/upload")
public BaseResponse<String> testUploadFile(@RequestPart("file") MultipartFile multipartFile) {
    // æ–‡ä»¶ç›®å½•
    String filename = multipartFile.getOriginalFilename();
    String filepath = String.format("/test/%s", filename);
    File file = null;
    try {
        // ä¸Šä¼ æ–‡ä»¶
        file = File.createTempFile(filepath, null);
        multipartFile.transferTo(file);
        cosManager.putObject(filepath, file);
        // è¿”å›å¯è®¿é—®åœ°å€
        return ResultUtils.success(filepath);
    } catch (Exception e) {
        log.error("file upload error, filepath = " + filepath, e);
        throw new BusinessException(ErrorCode.SYSTEM_ERROR, "ä¸Šä¼ å¤±è´¥");
    } finally {
        if (file != null) {
            // åˆ é™¤ä¸´æ—¶æ–‡ä»¶
            boolean delete = file.delete();
            if (!delete) {
                log.error("file delete error, filepath = {}", filepath);
            }
        }
    }
}
```



4ï¼‰æµ‹è¯•æ¥å£ã€‚

ä½¿ç”¨ local é…ç½®å¯åŠ¨é¡¹ç›®ï¼š

![img](https://pic.yupi.icu/1/1704271100915-e1c93791-bacc-492c-9a5f-0386aea57611.png)



æ‰“å¼€ Swagger æ¥å£æ–‡æ¡£ï¼Œæµ‹è¯•æ–‡ä»¶ä¸Šä¼ ï¼š

![img](https://pic.yupi.icu/1/1704173842994-37407fb9-af02-4038-a50e-e1a74fb2ba22.png)



#### 4ã€æ–‡ä»¶ä¸‹è½½

å®˜æ–¹æ–‡æ¡£ä»‹ç»äº† 2 ç§æ–‡ä»¶ä¸‹è½½æ–¹å¼ã€‚ä¸€ç§æ˜¯ç›´æ¥ä¸‹è½½ COS çš„æ–‡ä»¶åˆ°åç«¯æœåŠ¡å™¨ï¼ˆé€‚åˆæœåŠ¡å™¨ç«¯å¤„ç†æ–‡ä»¶ï¼‰ï¼Œå¦ä¸€ç§æ˜¯è·å–åˆ°æ–‡ä»¶ä¸‹è½½è¾“å…¥æµï¼ˆé€‚åˆè¿”å›ç»™å‰ç«¯ç”¨æˆ·ï¼‰ã€‚

å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š

- https://cloud.tencent.com/document/product/436/65937
- https://cloud.tencent.com/document/product/436/10199#.E4.B8.8B.E8.BD.BD.E5.AF.B9.E8.B1.A1



å…¶å®è¿˜æœ‰ç¬¬ä¸‰ç§â€œä¸‹è½½æ–¹å¼â€ï¼Œç›´æ¥é€šè¿‡è·¯å¾„é“¾æ¥è®¿é—®ï¼Œé€‚ç”¨äºå•ä¸€çš„ã€å¯ä»¥è¢«ç”¨æˆ·å…¬å¼€è®¿é—®çš„èµ„æºï¼Œæ¯”å¦‚ç”¨æˆ·å¤´åƒã€æœ¬é¡¹ç›®ä¸­çš„ä»£ç ç”Ÿæˆå™¨å›¾ç‰‡ã€‚

ä½†æ˜¯å¯¹äºæœ¬é¡¹ç›®ä¸­çš„ä»£ç ç”Ÿæˆå™¨äº§ç‰©åŒ…æ–‡ä»¶ï¼Œæ›´å»ºè®®é€šè¿‡åç«¯æœåŠ¡å™¨ä» COS ä¸‹è½½æ–‡ä»¶å¹¶è¿”å›ç»™å‰ç«¯ï¼Œè¿™æ ·å¯ä»¥åœ¨åç«¯é™åˆ¶åªæœ‰ç™»å½•ç”¨æˆ·æ‰èƒ½ä¸‹è½½ã€‚



1ï¼‰é¦–å…ˆåœ¨ `CosManager` ä¸­æ–°å¢å¯¹è±¡ä¸‹è½½æ–¹æ³•ï¼Œæ ¹æ®å¯¹è±¡çš„ key è·å–å­˜å‚¨ä¿¡æ¯ï¼š

```java
/**
 * ä¸‹è½½å¯¹è±¡
 *
 * @param key å”¯ä¸€é”®
 * @return
 */
public COSObject getObject(String key) {
    GetObjectRequest getObjectRequest = new GetObjectRequest(cosClientConfig.getBucket(), key);
    return cosClient.getObject(getObjectRequest);
}
```



2ï¼‰ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œåœ¨ `FileController` ä¸­ç¼–å†™æµ‹è¯•æ–‡ä»¶ä¸‹è½½æ¥å£ã€‚

æ ¸å¿ƒæµç¨‹æ˜¯æ ¹æ®è·¯å¾„è·å–åˆ° COS æ–‡ä»¶å¯¹è±¡ï¼Œç„¶åå°†æ–‡ä»¶å¯¹è±¡è½¬æ¢ä¸ºæ–‡ä»¶æµï¼Œå¹¶å†™å…¥åˆ° Servlet çš„ Response å¯¹è±¡ä¸­ã€‚æ³¨æ„è¦è®¾ç½®æ–‡ä»¶ä¸‹è½½ä¸“å±çš„å“åº”å¤´ã€‚

åŒä¸Šï¼Œæµ‹è¯•æ¥å£ä¸€å®šè¦åŠ ä¸Šç®¡ç†å‘˜æƒé™ï¼é˜²æ­¢ä»»ä½•ç”¨æˆ·éšæ„ä¸Šä¼ æ–‡ä»¶ã€‚

æµ‹è¯•æ–‡ä»¶ä¸‹è½½æ¥å£ä»£ç å¦‚ä¸‹ï¼š

```java
/**
 * æµ‹è¯•æ–‡ä»¶ä¸‹è½½
 *
 * @param filepath
 * @param response
 * @return
 */
@AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
@GetMapping("/test/download/")
public void testDownloadFile(String filepath, HttpServletResponse response) throws IOException {
    COSObjectInputStream cosObjectInput = null;
    try {
        COSObject cosObject = cosManager.getObject(filepath);
        cosObjectInput = cosObject.getObjectContent();
        // å¤„ç†ä¸‹è½½åˆ°çš„æµ
        byte[] bytes = IOUtils.toByteArray(cosObjectInput);
        // è®¾ç½®å“åº”å¤´
        response.setContentType("application/octet-stream;charset=UTF-8");
        response.setHeader("Content-Disposition", "attachment; filename=" + filepath);
        // å†™å…¥å“åº”
        response.getOutputStream().write(bytes);
        response.getOutputStream().flush();
    } catch (Exception e) {
        log.error("file download error, filepath = " + filepath, e);
        throw new BusinessException(ErrorCode.SYSTEM_ERROR, "ä¸‹è½½å¤±è´¥");
    } finally {
        if (cosObjectInput != null) {
            cosObjectInput.close();
        }
    }
}
```



3ï¼‰å¯åŠ¨é¡¹ç›®ï¼Œæ‰“å¼€ Swagger æ¥å£æ–‡æ¡£ï¼Œæµ‹è¯•æ–‡ä»¶ä¸‹è½½ï¼š

![img](https://pic.yupi.icu/1/1704176210010-b2d9ee12-4e70-4324-999a-a91d36f3c794.png)



è‡³æ­¤ï¼Œåç«¯æ“ä½œå¯¹è±¡å­˜å‚¨çš„ä»£ç å·²ç¼–å†™å®Œæˆï¼Œä¸‹é¢å†™ä¸€ä¸ªå‰ç«¯é¡µé¢æ¥æµ‹è¯•æ–‡ä»¶çš„ä¸Šä¼ å’Œä¸‹è½½ã€‚



## å‰ç«¯æ–‡ä»¶ä¸Šä¼  / ä¸‹è½½

åŸºäº [ç¼–ç¨‹å¯¼èˆªå‰ç«¯ä¸‡ç”¨æ¨¡æ¿](https://www.codefather.cn/course/1789200994552225793) å¼€å‘



1ï¼‰é¦–å…ˆä½¿ç”¨ openAPI å·¥å…·ç”Ÿæˆæ¥å£ï¼ˆæˆ–è€…è‡ªå·±ç¼–å†™ç±»ä¼¼çš„ä»£ç ï¼‰ã€‚

å¯ä»¥çœ‹åˆ°å·¥å…·ä¸ºæˆ‘ä»¬ç”Ÿæˆäº†æ–‡ä»¶ä¸Šä¼ è¯·æ±‚å‡½æ•°ï¼Œç­‰ä¼šå„¿ç›´æ¥ç”¨å°±è¡Œï¼Œçˆ½æ­ªæ­ª~

![img](https://pic.yupi.icu/1/1704271822201-b9cdf622-2ac6-440a-bfd2-5f974bf44d65.png)



2ï¼‰æ–°å»ºæ–‡ä»¶ä¸Šä¼ ä¸‹è½½æµ‹è¯•é¡µé¢ï¼Œå¹¶æ·»åŠ è·¯ç”±ï¼š

```javascript
{
  path: '/test/file',
  icon: 'home',
  component: './Test/File',
  name: 'æ–‡ä»¶ä¸Šä¼ ä¸‹è½½æµ‹è¯•',
  hideInMenu: true,
},
```



æ–°å»ºçš„æ–‡ä»¶ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š

![img](https://pic.yupi.icu/1/1704272061568-486f13d0-d401-4e91-9baf-9d4feaeb0f7e.png)



3ï¼‰æ–°å¢å¯¹è±¡å­˜å‚¨ç›¸å…³å¸¸é‡ã€‚

ä¿®æ”¹ `constants/index.ts` æ–‡ä»¶ï¼Œæ·»åŠ ä¸‹åˆ—ä»£ç ï¼š

```javascript
/**
 * COS è®¿é—®åœ°å€
 */
export const COS_HOST = "https://yuzi-1256524210.cos.ap-shanghai.myqcloud.com";
```



4ï¼‰å¼€å‘é¡µé¢ã€‚

éµå¾ª Flex å·¦å³å¸ƒå±€ï¼Œå·¦è¾¹ä¸Šä¼ æ–‡ä»¶ï¼Œå³è¾¹å±•ç¤ºå’Œä¸‹è½½æ–‡ä»¶ã€‚

å¯¹äºæ–‡ä»¶ä¸Šä¼ ï¼Œç›´æ¥ä½¿ç”¨ Ant Design çš„æ‹–æ‹½æ–‡ä»¶ä¸Šä¼ ç»„ä»¶ã€‚

å®˜æ–¹æ–‡æ¡£ï¼šhttps://ant.design/components/upload-cn#components-upload-demo-drag

![img](https://pic.yupi.icu/1/1704272168315-34df9197-676f-4af2-b838-64b2ff082667.png)



å‚è€ƒä»£ç å¦‚ä¸‹ï¼Œæˆ‘ä»¬åœ¨ `customRequest` å­—æ®µä¸­è‡ªå®šä¹‰äº†ä¸Šä¼ æ–‡ä»¶çš„è¯·æ±‚é€»è¾‘ï¼š

```tsx
const props: UploadProps = {
  name: 'file',
  multiple: false,
  maxCount: 1,
  customRequest: async (fileObj: any) => {
    try {
      const res = await testUploadFileUsingPost({}, fileObj.file);
      fileObj.onSuccess(res.data);
      setValue(res.data);
    } catch (e: any) {
      message.error('ä¸Šä¼ å¤±è´¥ï¼Œ' + e.message);
      fileObj.onError(e);
    }
  },
  onRemove() {
    setValue(undefined);
  },
};

<Card title="æ–‡ä»¶ä¸Šä¼ ">
  <Dragger {...props}>
    <p className="ant-upload-drag-icon">
      <InboxOutlined />
    </p>
    <p className="ant-upload-text">Click or drag file to this area to upload</p>
    <p className="ant-upload-hint">
      Support for a single or bulk upload. Strictly prohibited from uploading company data or
      other banned files.
    </p>
  </Dragger>
</Card>
```



å¯¹äºæ–‡ä»¶ä¸‹è½½ï¼Œä½¿ç”¨ `img` æ ‡ç­¾ç›´æ¥æ‹¼æ¥å›¾ç‰‡åœ°å€å¹¶å±•ç¤ºï¼š

```tsx
<div>æ–‡ä»¶åœ°å€ï¼š{COS_HOST + value}</div>
<Divider />
<img src={COS_HOST + value} height={280} />
```



ä½¿ç”¨ `file-saver` åº“ï¼Œå¯ä»¥ä¸‹è½½åç«¯è¿”å›çš„ blob å†…å®¹ä¸ºæ–‡ä»¶ã€‚

å…ˆå®‰è£… `file-saver` åº“ï¼š

```bash
npm install file-saver
npm i --save-dev @types/file-saver
```



ä¸‹è½½æ–‡ä»¶ä»£ç å¦‚ä¸‹ï¼š

```tsx
import { saveAs } from 'file-saver';

<Button
  onClick={async () => {
    const blob = await testDownloadFileUsingGet({
      filepath: value,
    }, {
      responseType: "blob",
    });
    // ä½¿ç”¨ file-saver æ¥ä¿å­˜æ–‡ä»¶
    const fullPath = COS_HOST + value;
    saveAs(blob, fullPath.substring(fullPath.lastIndexOf("/") + 1));
  }}
>
  ç‚¹å‡»ä¸‹è½½æ–‡ä»¶
</Button>
```



ç”±äºåç«¯ä¸‹è½½æ–‡ä»¶æ¥å£ä¸è¿”å› `code` çŠ¶æ€ç ï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹å“åº”æ‹¦æˆªå™¨ï¼Œå¯¹äºæ–‡ä»¶ä¸‹è½½è¯·æ±‚ï¼Œç›´æ¥è¿”å› blob å¯¹è±¡ã€‚ä¿®æ”¹ `requestConfig.ts` çš„éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š

```javascript
// å“åº”æ‹¦æˆªå™¨
responseInterceptors: [
  (response) => {
    // è¯·æ±‚åœ°å€
    const requestPath: string = response.config.url ?? '';

    // å“åº”
    const { data } = response as unknown as ResponseStructure;
    if (!data) {
      throw new Error('æœåŠ¡å¼‚å¸¸');
    }

    // æ–‡ä»¶ä¸‹è½½æ—¶ï¼Œç›´æ¥è¿”å›
    if (requestPath.includes("download")) {
      return response;
    }

  	...
  },
]
```



é¡µé¢çš„å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```tsx
import { COS_HOST } from '@/constants';
import {
  testDownloadFileUsingGet,
  testUploadFileUsingPost,
} from '@/services/backend/fileController';
import { InboxOutlined } from '@ant-design/icons';
import { Button, Card, Divider, Flex, message, Upload, UploadProps } from 'antd';
import { saveAs } from 'file-saver';
import React, { useState } from 'react';

const { Dragger } = Upload;

/**
 * æ–‡ä»¶ä¸Šä¼ ä¸‹è½½æµ‹è¯•é¡µé¢
 * @constructor
 */
const TestFilePage: React.FC = () => {
  const [value, setValue] = useState<string>();

  const props: UploadProps = {
    name: 'file',
    multiple: false,
    maxCount: 1,
    customRequest: async (fileObj: any) => {
      try {
        const res = await testUploadFileUsingPost({}, fileObj.file);
        fileObj.onSuccess(res.data);
        setValue(res.data);
      } catch (e: any) {
        message.error('ä¸Šä¼ å¤±è´¥ï¼Œ' + e.message);
        fileObj.onError(e);
      }
    },
    onRemove() {
      setValue(undefined);
    },
  };

  return (
    <Flex gap={16}>
      <Card title="æ–‡ä»¶ä¸Šä¼ ">
        <Dragger {...props}>
          <p className="ant-upload-drag-icon">
            <InboxOutlined />
          </p>
          <p className="ant-upload-text">Click or drag file to this area to upload</p>
          <p className="ant-upload-hint">
            Support for a single or bulk upload. Strictly prohibited from uploading company data or
            other banned files.
          </p>
        </Dragger>
      </Card>
      <Card title="æ–‡ä»¶ä¸‹è½½" loading={!value}>
        <div>æ–‡ä»¶åœ°å€ï¼š{COS_HOST + value}</div>
        <Divider />
        <img src={COS_HOST + value} height={280} />
        <Divider />
        <Button
          onClick={async () => {
            const blob = await testDownloadFileUsingGet(
              {
                filepath: value,
              },
              {
                responseType: 'blob',
              },
            );
            // ä½¿ç”¨ file-saver æ¥ä¿å­˜æ–‡ä»¶
            const fullPath = COS_HOST + value;
            saveAs(blob, fullPath.substring(fullPath.lastIndexOf('/') + 1));
          }}
        >
          ç‚¹å‡»ä¸‹è½½æ–‡ä»¶
        </Button>
      </Card>
    </Flex>
  );
};

export default TestFilePage;
```



5ï¼‰æ‰“å¼€é¡µé¢ï¼Œæµ‹è¯•æ–‡ä»¶ä¸Šä¼ ã€æ˜¾ç¤ºå’Œä¸‹è½½ã€‚é¡µé¢æ•ˆæœå¦‚ä¸‹ï¼š



![img](https://pic.yupi.icu/1/1704272849294-580806a6-d22e-4598-a74b-cf41013dbc01.png)



è‡³æ­¤ï¼Œé€šç”¨çš„æ–‡ä»¶ä¸Šä¼ å’Œä¸‹è½½åŠŸèƒ½å·²å¼€å‘å®Œæˆã€‚



## å®è·µ

ç¼–ç¨‹å¯¼èˆªçš„å®šåˆ¶åŒ–ä»£ç ç”Ÿæˆé¡¹ç›®ä¼šæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨å¯¹è±¡å­˜å‚¨å®ç°æ–‡ä»¶ä¸Šä¼  / ä¸‹è½½åŠŸèƒ½ã€‚

ğŸ‘‰ğŸ» ç¼–ç¨‹å¯¼èˆªåŸåˆ›é¡¹ç›®æ•™ç¨‹ç³»åˆ—ï¼šhttps://yuyuanweb.feishu.cn/wiki/SePYwTc9tipQiCktw7Uc7kujnCd
